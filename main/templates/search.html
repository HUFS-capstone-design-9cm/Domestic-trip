{% load static %}
<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>
    
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0"> -->
	<title>ê²½ë¡œ ì¶”ì²œ</title>
    <script src="https://code.jquery.com/jquery-3.6.4.js"></script>

    <link rel="stylesheet" type="text/css" href="{% static 'css/reset.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/search.css' %}">
</head>
<body>    
    <section id="main_contents">
        <div class="container">
            <div class="map">
                <h1>ğŸ§­ ê²½ë¡œ ì¶”ì²œ</h1>
                <div id="map" style="width:600px;height:500px;"></div>
            </div>
            <div class="route">
                {% for spot in routes.keys %}
                <ul>ğŸ“ {{ spot }}</ul>
                {% if not forloop.last %}
                    <ul>â¬‡ï¸</ul>
                {% endif %}
                {% endfor %}
            </div>
            <div class="question-box">
                <!-- <h2>ì¹´ì¹´ì˜¤ ê¸¸ì°¾ê¸° OpenAPIë¥¼ ì´ìš©</h2> -->
                <ul id="names-q1">
                </ul>
            </div>

            <form class="survey" name="f1" method="POST" action="/survey/" onsubmit="return vCheck();">
                {% csrf_token %}
                <input type="hidden" name="traveler-pk" value="{{ traveler_id }}">
                <div class="btn">
                    <input class="survey_btn" type="submit" value="ë§Œì¡±ë„ ì¡°ì‚¬í•˜ê¸°" style="font-weight: normal;">
                </div>        
            </form>
            <div class="logo">
                <img src="{% static 'image/logo.png' %}" alt="logo" height="100px" width="200px">
            </div>
        </div>
    </section>
	<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c963b5273576eb43b2c68c2088700c47"></script>
    <script>
        let routes = JSON.parse("{{ route_js | escapejs }}");
        var start = routes.start;
        var ways = [];
        const bar = "|";
        var waypoints = "";
        var origin = {"x": start.lat, "y": start.lng};
        console.log(routes);
        for(let i = 2; i <= Object.keys(routes).length; i++){
            for(route of Object.keys(routes)){
                if(routes[route].sequence == Object.keys(routes).length) {
                    var destination = {"x": routes[route].lat, "y": routes[route].lng};
                }
                else {
                    if (routes[route].sequence == i) {
                        ways.push({"x": routes[route].lat, "y": routes[route].lng})
                    }
                }
            }   
        }
        for (way of ways){
            if (waypoints != ""){
                waypoints = waypoints + bar + way.y + "," + way.x 
            }
            else {
                waypoints = way.y + "," + way.x
            }
        }

        $.ajax({
              type: "GET",
              url: "https://apis-navi.kakaomobility.com/v1/directions?origin="+origin.y+","+origin.x+"&destination="+destination.y+","+destination.x+"&waypoints="+waypoints+"&priority=RECOMMEND&car_fuel=GASOLINE&car_hipass=false&alternatives=false&road_details=false",
              headers:{
                  Authorization: "KakaoAK 479cc207c3f10290fe4d4afc2ddec48d",
              }
        }).done(function (msg) {
            console.log(msg);
            var container = document.getElementById('map');
            var options = {
                center: new kakao.maps.LatLng(origin.x, origin.y),
                level: 10,
                marker: marker
            };

            var map = new kakao.maps.Map(container, options);
            
            // ë§ˆì»¤ ìƒì„±í•˜ê¸°
            for (route of Object.keys(routes)) {
                var markerPosition  = new kakao.maps.LatLng(routes[route].lat, routes[route].lng); 
                // ë§ˆì»¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
                var marker = new kakao.maps.Marker({
                    map: map,
                    position: markerPosition,
                });
                
                var infowindow = new kakao.maps.InfoWindow({
                    content: route // ì¸í¬ìœˆë„ìš°ì— í‘œì‹œí•  ë‚´ìš©
                });

                (function(marker, infowindow) {
                    // ë§ˆì»¤ì— mouseover ì´ë²¤íŠ¸ë¥¼ ë“±ë¡í•˜ê³  ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì‹œ ì¸í¬ìœˆë„ìš°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤ 
                    kakao.maps.event.addListener(marker, 'mouseover', function() {
                        infowindow.open(map, marker);
                    });

                    // ë§ˆì»¤ì— mouseout ì´ë²¤íŠ¸ë¥¼ ë“±ë¡í•˜ê³  ë§ˆìš°ìŠ¤ ì•„ì›ƒ ì‹œ ì¸í¬ìœˆë„ìš°ë¥¼ ë‹«ìŠµë‹ˆë‹¤
                    kakao.maps.event.addListener(marker, 'mouseout', function() {
                        infowindow.close();
                    });
                })(marker, infowindow);
            }
            
            
            var guides = msg.routes[0].sections;
            var markers = [];
            var linePath;
            var lineLine = new kakao.maps.Polyline();
            
            for (guide of guides) {
                for (var i of guide.guides) {
                    markers.push({"x": i.x, "y": i.y});
                }
            }

            for (var k = 0; k < markers.length; k++ ){
                if (k != 0) {
                    linePath = [
                        new kakao.maps.LatLng(markers[k-1].y, markers[k-1].x), 
                        new kakao.maps.LatLng(markers[k].y, markers[k].x)]
                }
                lineLine.setPath(linePath);
                
                var polyline = new kakao.maps.Polyline({
                    map: map,
                    path: linePath, // ì„ ì„ êµ¬ì„±í•˜ëŠ” ì¢Œí‘œë°°ì—´ ì…ë‹ˆë‹¤
                    strokeWeight: 5, // ì„ ì˜ ë‘ê»˜ ì…ë‹ˆë‹¤
                    strokeColor: '#db4040', // ì„ ì˜ ìƒ‰ê¹”ì…ë‹ˆë‹¤
                    strokeOpacity: 1, // ì„ ì˜ ë¶ˆíˆ¬ëª…ë„ ì…ë‹ˆë‹¤ 1ì—ì„œ 0 ì‚¬ì´ì˜ ê°’ì´ë©° 0ì— ê°€ê¹Œìš¸ìˆ˜ë¡ íˆ¬ëª…í•©ë‹ˆë‹¤
                    strokeStyle: 'solid' // ì„ ì˜ ìŠ¤íƒ€ì¼ì…ë‹ˆë‹¤
                });
            }
            // ì§€ë„ì— í‘œì‹œí•  ì„ ì„ ìƒì„±í•©ë‹ˆë‹¤
            $("#names-q1").empty(); //í™”ë©´ì— ì¶œë ¥ ì „ì— ì§€ì›Œì£¼ëŠ” ì½”ë“œ
            let mise = msg.routes[0].summary;
            let duration = (mise.duration/60).toFixed();
            // $("#names-q1").append(`<li>í†µí–‰ìš”ê¸ˆ : ${mise.fare.toll}ì›</li>`);
            // $("#names-q1").append(`<li>íƒì‹œìš”ê¸ˆ : ${mise.fare.taxi}ì›</li>`);
            $("#names-q1").append(`<li>âœ… ì „ì²´ê±°ë¦¬ : ${mise.distance/1000}km</li>`);
            $("#names-q1").append(`<li>âœ… ì†Œìš”ì‹œê°„ : ì•½ ${duration}ë¶„</li>`); 
        
            }
            )
    </script>
</body>
</html>